<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Cleaner - WebApp v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .thinking { animation: pulse 1.5s ease-in-out infinite; }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen antialiased">
    <div id="app"></div>

    <!-- React et ReactDOM AVANT Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const inferApiBase = () => {
            const origin = window.location.origin;
            if (origin && origin.startsWith('http')) {
                return origin.replace(/\/$/, '');
            }
            return 'http://localhost:5000';
        };

        const API_BASE = inferApiBase();
        const apiUrl = (path = '/') => `${API_BASE}${path.startsWith('/') ? path : `/${path}`}`;
        const apiFetch = (path, options = {}) => fetch(apiUrl(path), options);

        // WebSocket connection
        const socket = io(API_BASE, { transports: ['websocket', 'polling'] });

        const FILE_TYPE_OPTIONS = [
            { key: 'images', label: 'Images', category: 'Images', emoji: 'üñºÔ∏è' },
            { key: 'videos', label: 'Vid√©os', category: 'Videos', emoji: 'üéûÔ∏è' },
            { key: 'audio', label: 'Audio', category: 'Audio', emoji: 'üéß' },
            { key: 'documents', label: 'Textes & Docs', category: 'Documents', emoji: 'üìÑ' },
            { key: 'archives', label: 'Archives', category: 'Archives', emoji: 'üóúÔ∏è' },
            { key: 'other', label: 'Autres', category: 'Autres', emoji: 'üì¶' }
        ];

        const DEFAULT_FILE_TYPES = FILE_TYPE_OPTIONS.reduce((acc, option) => {
            acc[option.key] = !['archives', 'other'].includes(option.key);
            return acc;
        }, {});

        // Fonction pour persister l'√©tat
        const saveState = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('Erreur sauvegarde √©tat:', e);
            }
        };

        const loadState = (key, defaultValue) => {
            try {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        };

        const getDefaultConfig = () => ({
            path: '',
            min_age_days: 0,
            min_size_mb: 0,
            max_files: 100,
            model: 'llama3:8b',
            exclude_audio: false,
            exclude_images: false,
            exclude_videos: false,
            delete_empty: true,
            organize_kept_files: true,
            fileTypes: { ...DEFAULT_FILE_TYPES }
        });

        function App() {
            const [status, setStatus] = useState(loadState('status', 'idle')); // idle, scanning, analyzing, complete
            const [config, setConfig] = useState(() => {
                const saved = loadState('config', null);
                if (!saved) {
                    return getDefaultConfig();
                }
                return {
                    ...getDefaultConfig(),
                    ...saved,
                    fileTypes: { ...DEFAULT_FILE_TYPES, ...(saved.fileTypes || {}) }
                };
            });
            
            const [quickDeleteCategories, setQuickDeleteCategories] = useState(loadState('quickDeleteCategories', {
                'Installers': false,
                'Archives': false,
                'Images': false,
                'Documents': false,
                'Audio': false,
                'Videos': false,
                'Autres': false
            }));
            
            const [scanProgress, setScanProgress] = useState(loadState('scanProgress', { scanned: 0, message: '' }));
            const [manualPathInput, setManualPathInput] = useState(config.path || '');
            const [analyzeProgress, setAnalyzeProgress] = useState(loadState('analyzeProgress', { current: 0, total: 0, file: '' }));
            const [aiThinking, setAiThinking] = useState(null);
            const [results, setResults] = useState(loadState('results', { can_delete: [], should_keep: [], need_review: [] }));
            const [stats, setStats] = useState(loadState('stats', null));
            const [candidates, setCandidates] = useState(loadState('candidates', []));
            const [protectedFiles, setProtectedFiles] = useState(loadState('protectedFiles', []));
            const [logs, setLogs] = useState(loadState('logs', []));
            
            const abortController = useRef(null);

            const activeFileTypes = { ...DEFAULT_FILE_TYPES, ...(config.fileTypes || {}) };

            const toggleFileType = (key) => {
                setConfig(prev => {
                    const merged = { ...DEFAULT_FILE_TYPES, ...(prev.fileTypes || {}) };
                    return {
                        ...prev,
                        fileTypes: {
                            ...merged,
                            [key]: !merged[key]
                        }
                    };
                });
            };

            // Sauvegarder l'√©tat √† chaque changement
            useEffect(() => {
                saveState('status', status);
            }, [status]);

            useEffect(() => {
                saveState('config', config);
            }, [config]);

            useEffect(() => {
                saveState('quickDeleteCategories', quickDeleteCategories);
            }, [quickDeleteCategories]);

            useEffect(() => {
                saveState('scanProgress', scanProgress);
            }, [scanProgress]);

            useEffect(() => {
                saveState('analyzeProgress', analyzeProgress);
            }, [analyzeProgress]);

            useEffect(() => {
                saveState('results', results);
            }, [results]);

            useEffect(() => {
                saveState('stats', stats);
            }, [stats]);

            useEffect(() => {
                saveState('candidates', candidates);
            }, [candidates]);

            useEffect(() => {
                saveState('protectedFiles', protectedFiles);
            }, [protectedFiles]);

            useEffect(() => {
                saveState('logs', logs);
            }, [logs]);

            useEffect(() => {
                setManualPathInput(config.path || '');
            }, [config.path]);

            useEffect(() => {
                // WebSocket listeners
                socket.on('connected', () => addLog('‚úÖ Connect√© au serveur'));

                socket.on('scan_started', (data) => {
                    setStatus('scanning');
                    setCandidates([]);
                    setProtectedFiles([]);
                    setStats(null);
                    setScanProgress({ scanned: 0, message: 'Scan d√©marr√©...' });
                    setAiThinking(null);
                    addLog(`üîç Scan d√©marr√©: ${data.path}`);
                });

                socket.on('scan_progress', (data) => {
                    setScanProgress(data);
                });

                socket.on('scan_finished', (data) => {
                    setStatus('idle');
                    const protectedList = data.protected || [];
                    setStats({
                        total_files: data.total_files || data.count,
                        candidate_count: data.count,
                        stats: data.stats || {},
                        selected_categories: data.selected_categories || null
                    });
                    setCandidates(data.files || []);
                    setProtectedFiles(protectedList);
                    addLog(`‚úÖ Scan termin√©: ${data.count} candidats IA, ${protectedList.length} prot√©g√©s`);
                });

                socket.on('scan_cancelled', (data) => {
                    setStatus('idle');
                    addLog('‚ö†Ô∏è Scan annul√©');
                });

                socket.on('scan_error', (data) => {
                    setStatus('idle');
                    const detail = data && data.path ? `Path: ${data.path}` : null;
                    addLog({
                        message: `‚ùå Scan error: ${data && data.error ? data.error : 'Unknown error'}`,
                        detail,
                        color: 'text-red-400'
                    });
                });

                socket.on('analyze_started', (data) => {
                    setStatus('analyzing');
                    setAnalyzeProgress({ current: 0, total: data.total || 0, file: '' });
                });

                socket.on('analyze_progress', (data) => {
                    setAnalyzeProgress(prev => ({
                        current: data.current,
                        total: data.total,
                        file: data.file
                    }));
                    
                    // Log les d√©cisions en temps r√©el
                    if (data.decision === 'DELETE') {
                        addLog({
                            message: `üü¢ SUPPRIMER: ${data.file}`,
                            detail: data.reason,
                            color: 'text-green-400'
                        });
                    } else if (data.decision === 'KEEP') {
                        addLog({
                            message: `üîµ CONSERVER: ${data.file}`,
                            detail: data.reason,
                            color: 'text-blue-400'
                        });
                    } else if (data.decision === 'REVIEW') {
                        addLog({
                            message: `üü° REVISION: ${data.file}`,
                            detail: data.reason,
                            color: 'text-yellow-400'
                        });
                    }
                });
                
                // CORRIG√â: Gestion des r√©sultats d'analyse
                socket.on('analyze_complete', (data) => {
                    setStatus('complete');
                    setAiThinking(null);

                    // Organiser les r√©sultats par d√©cision
                    const can_delete = data.results.filter(r => r.decision === 'DELETE');
                    const should_keep = data.results.filter(r => r.decision === 'KEEP');
                    const need_review = data.results.filter(r => r.decision === 'REVIEW');
                    
                    setResults({
                        can_delete: can_delete,
                        should_keep: should_keep,
                        need_review: need_review
                    });
                    
                    addLog(`‚úÖ Analyse termin√©e: ${can_delete.length} √† supprimer, ${should_keep.length} √† conserver, ${need_review.length} √† r√©viser`);
                });

                socket.on('analyze_error', (data) => {
                    setStatus('idle');
                    setAiThinking(null);
                    addLog({
                        message: `‚ùå Analyse erreur: ${data && data.error ? data.error : 'Unknown error'}`,
                        color: 'text-red-400'
                    });
                });

                socket.on('ai_thinking', (data) => {
                    if (data && data.file) {
                        setAiThinking(data);
                    }
                });

                socket.on('ai_result', () => {
                    setAiThinking(null);
                });
                
                socket.on('file_deleted', (data) => {
                    addLog(`üóëÔ∏è Supprim√©: ${data.path.split('/').pop()}`);
                });

                socket.on('deletion_complete', (data) => {
                    addLog(`‚úÖ Suppression termin√©e: ${data.deleted} fichiers supprim√©s (${data.size_freed_h} lib√©r√©s)`);
                });

                // Cleanup √† la fermeture de la page
                const handleUnload = () => {
                    apiFetch('/api/stop', { method: 'POST' })
                        .catch(() => {}); // Ignore les erreurs
                };
                
                window.addEventListener('beforeunload', handleUnload);

                return () => {
                    socket.off('connected');
                    socket.off('scan_started');
                    socket.off('scan_progress');
                    socket.off('scan_finished');
                    socket.off('scan_cancelled');
                    socket.off('scan_error');
                    socket.off('analyze_started');
                    socket.off('analyze_progress');
                    socket.off('analyze_complete');
                    socket.off('analyze_error');
                    socket.off('ai_thinking');
                    socket.off('ai_result');
                    socket.off('file_deleted');
                    socket.off('deletion_complete');
                    window.removeEventListener('beforeunload', handleUnload);
                };
            }, []);


            const addLog = (messageOrObj) => {
                if (typeof messageOrObj === 'string') {
                    setLogs(prev => [...prev, { 
                        time: new Date().toLocaleTimeString(), 
                        message: messageOrObj,
                        color: 'text-white'
                    }]);
                } else {
                    setLogs(prev => [...prev, { 
                        time: new Date().toLocaleTimeString(), 
                        ...messageOrObj 
                    }]);
                }
            };

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
                return (bytes / (1024 * 1024 * 1024)).toFixed(1) + 'GB';
            };

            const truncate = (value, max = 160) => {
                if (!value) return '';
                return value.length > max ? value.slice(0, max) + '‚Ä¶' : value;
            };

            const selectFolder = async () => {
                try {
                    const response = await apiFetch('/api/select_folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.ok && data.path) {
                        setConfig(prev => ({ ...prev, path: data.path }));
                        addLog(`üìÅ Dossier s√©lectionn√©: ${data.path}`);
                        if (data.warning) {
                            addLog({ message: `‚ö†Ô∏è ${data.warning}`, color: 'text-amber-300' });
                        }
                    } else {
                        addLog('‚ùå S√©lection dossier: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    addLog('‚ùå S√©lection dossier: ' + error.message);
                }
            };

            const startScan = async () => {
                if (!config.path) {
                    addLog('‚ùå S√©lectionne d\'abord un dossier');
                    return;
                }

                const selectedCategories = FILE_TYPE_OPTIONS
                    .filter(option => activeFileTypes[option.key])
                    .map(option => option.category);

                if (selectedCategories.length === 0) {
                    addLog('‚ö†Ô∏è Select at least one file type to scan');
                    return;
                }

                addLog(`üéØ Types scann√©s: ${selectedCategories.join(', ')}`);

                abortController.current = new AbortController();

                try {
                    const minAgeDays = Number(config.min_age_days) || 0;
                    const minSizeMb = Number(config.min_size_mb) || 0;

                    const response = await apiFetch('/api/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: config.path,
                            categories: selectedCategories,
                            min_age_days: minAgeDays,
                            min_size_mb: minSizeMb
                        }),
                        signal: abortController.current.signal
                    });

                    const data = await response.json();
                    if (!data.ok) {
                        addLog('‚ùå Erreur scan: ' + data.error);
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        addLog('‚ùå Erreur scan: ' + error.message);
                    }
                } finally {
                    abortController.current = null;
                }
            };

            const checkAiStatus = async () => {
                const modelToCheck = (config.model && config.model.trim()) || 'llama3:8b';
                try {
                    const response = await apiFetch(`/api/ai_status?model=${encodeURIComponent(modelToCheck)}`);
                    const data = await response.json();
                    if (data.ok) {
                        addLog(`‚úÖ Ollama pr√™t (${modelToCheck}) via ${data.ollama_url}`);
                    } else {
                        addLog(`‚ùå AI setup: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    addLog('‚ùå AI status check failed: ' + error.message);
                }
            };

            const startAnalyze = async () => {
                if (!candidates || candidates.length === 0) {
                    addLog('‚ùå Aucun fichier √† analyser. Lancez d\'abord un scan.');
                    return;
                }

                abortController.current = new AbortController();

                const filesToAnalyze = candidates.slice(0, config.max_files);

                if (filesToAnalyze.length === 0) {
                    addLog('‚ö†Ô∏è Aucun fichier disponible pour l\'IA');
                    return;
                }

                const modelToUse = (config.model && config.model.trim()) || 'llama3:8b';
                setStatus('analyzing');
                setAnalyzeProgress({ current: 0, total: filesToAnalyze.length, file: '' });
                addLog(`üß† D√©marrage de l'analyse de ${filesToAnalyze.length} fichiers...`);

                try {
                    const response = await apiFetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            paths: filesToAnalyze.map(file => file.file || file.path || file),
                            model: modelToUse,
                            max_files: config.max_files
                        }),
                        signal: abortController.current.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} on ${response.url}`);
                    }

                    const data = await response.json();

                    if (data.ok) {
                        const analyzedCount = data.count ?? filesToAnalyze.length;
                        addLog(`‚úÖ Analyse API termin√©e: ${analyzedCount} fichiers trait√©s`);
                    } else {
                        addLog('‚ùå Erreur analyse: ' + (data.error || 'Unknown error'));
                        setStatus('idle');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        addLog('‚ùå Erreur analyse: ' + error.message);
                        setStatus('idle');
                    }
                } finally {
                    abortController.current = null;
                }
            };

            const stopProcess = async () => {
                if (abortController.current) {
                    abortController.current.abort();
                    abortController.current = null;
                }
                
                try {
                    await apiFetch('/api/stop', {
                        method: 'POST'
                    });
                    addLog('‚èπÔ∏è Processus arr√™t√©');
                    setStatus('idle');
                    setAiThinking(null);
                } catch (error) {
                    addLog('‚ùå Erreur arr√™t: ' + error.message);
                }
            };

            const restartProcess = () => {
                // Reset tout
                setStatus('idle');
                setScanProgress({ scanned: 0, message: '' });
                setAnalyzeProgress({ current: 0, total: 0, file: '' });
                setResults({ can_delete: [], should_keep: [], need_review: [] });
                setStats(null);
                setCandidates([]);
                setProtectedFiles([]);
                setLogs([]);
                setAiThinking(null);
                setConfig(getDefaultConfig());
                setManualPathInput('');

                // Clear localStorage
                localStorage.clear();

                addLog('üîÑ Red√©marrage - √âtat r√©initialis√©');
            };

            const quickDeleteByCategory = async () => {
                const selected = Object.keys(quickDeleteCategories).filter(k => quickDeleteCategories[k]);
                
                if (selected.length === 0) {
                    addLog('‚ö†Ô∏è Aucune cat√©gorie s√©lectionn√©e');
                    return;
                }
                
                if (!confirm(`Supprimer TOUS les fichiers des cat√©gories: ${selected.join(', ')} ?`)) {
                    return;
                }
                
                try {
                    const response = await apiFetch('/api/delete_by_category', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ categories: selected })
                    });
                    
                    const data = await response.json();
                    if (data.ok) {
                        addLog(`‚úÖ Suppression rapide: ${data.deleted} fichiers (${data.size_freed_h} lib√©r√©s)`);
                        
                        if (data.errors > 0) {
                            addLog(`‚ö†Ô∏è ${data.errors} erreurs`);
                        }
                    } else {
                        addLog('‚ùå Erreur suppression: ' + data.error);
                    }
                } catch (error) {
                    addLog('‚ùå Erreur suppression: ' + error.message);
                }
            };

            const deleteSelected = async () => {
                if (results.can_delete.length === 0) {
                    addLog('‚ö†Ô∏è Aucun fichier √† supprimer');
                    return;
                }
                
                if (!confirm(`Supprimer ${results.can_delete.length} fichiers ?`)) {
                    return;
                }
                
                const paths = results.can_delete.map(r => r.file);
                
                try {
                    const response = await apiFetch('/api/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            files: paths,
                            simulate: false
                        })
                    });
                    
                    const data = await response.json();
                    if (data.ok) {
                        addLog(`‚úÖ Supprim√©s: ${data.deleted} fichiers (${data.size_freed_h} lib√©r√©s)`);
                        
                        if (data.errors > 0) {
                            addLog(`‚ö†Ô∏è ${data.errors} erreurs`);
                        }
                        
                        // Mettre √† jour les r√©sultats
                        setResults({
                            ...results,
                            can_delete: []
                        });
                    } else {
                        addLog('‚ùå Erreur suppression: ' + data.error);
                    }
                } catch (error) {
                    addLog('‚ùå Erreur suppression: ' + error.message);
                }
            };

            return (
                <div className="max-w-6xl mx-auto py-10 px-4 space-y-10">
                    {/* Header */}
                    <div className="space-y-3">
                        <p className="text-xs uppercase tracking-[0.35em] text-slate-400">AI Cleaner</p>
                        <div>
                            <h1 className="text-4xl font-semibold text-slate-900">ü§ñ AI Cleaner v3.0</h1>
                            <p className="text-base text-slate-500 mt-1">Une interface plus douce pour piloter ton nettoyage intelligent.</p>
                        </div>
                    </div>

                    {/* Layout 3 colonnes */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Colonne 1: Options & Scan */}
                        <div className="space-y-6">
                            {/* Configuration */}
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                <h2 className="text-2xl font-semibold text-slate-900 mb-6">‚öôÔ∏è Options</h2>
                                
                                {/* S√©lecteur de dossier */}
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <p className="text-sm font-medium text-slate-800">Dossier √† analyser</p>
                                        <p className="text-xs text-slate-500">Ouvre Finder pour choisir le dossier √† nettoyer.</p>
                                    </div>
                                    <div className="flex flex-col gap-3 sm:flex-row sm:items-center">
                                        <button
                                            type="button"
                                            onClick={selectFolder}
                                            className="inline-flex items-center justify-center rounded-full bg-sky-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-sky-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
                                        >
                                            üìÇ Choisir un dossier
                                        </button>
                                        <div className="flex-1 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600 break-all">
                                            {config.path || 'Aucun dossier s√©lectionn√©'}
                                        </div>
                                    </div>
                                
                                    <div>
                                        <p className="text-sm font-medium text-slate-800 mb-2">Types de fichiers √† scanner</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            {FILE_TYPE_OPTIONS.map(option => (
                                                <button
                                                    key={option.key}
                                                    type="button"
                                                    onClick={() => toggleFileType(option.key)}
                                                    className={`text-xs px-3 py-2 rounded-full border transition-all duration-200 ${
                                                        activeFileTypes[option.key]
                                                            ? 'bg-sky-50 text-sky-700 border-sky-200 shadow-sm'
                                                            : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'
                                                    }`}
                                                >
                                                    {option.emoji} {option.label}
                                                </button>
                                            ))}
                                        </div>
                                        <p className="text-[11px] text-slate-500 mt-2">Seuls les types coch√©s seront analys√©s.</p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-800 mb-1">Fichiers max √† analyser</label>
                                        <input
                                            type="number"
                                            min="1"
                                            value={config.max_files}
                                            onChange={(e) => setConfig({...config, max_files: Math.max(1, parseInt(e.target.value) || 1)})}
                                            className="w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700 focus:border-sky-400 focus:bg-white focus:outline-none focus:ring-2 focus:ring-sky-100"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-800 mb-1">Mod√®le IA (Ollama)</label>
                                        <div className="flex flex-col sm:flex-row gap-2">
                                            <input
                                                type="text"
                                                value={config.model}
                                                onChange={(e) => setConfig({...config, model: e.target.value})}
                                                className="flex-1 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700 focus:border-sky-400 focus:bg-white focus:outline-none focus:ring-2 focus:ring-sky-100"
                                            />
                                            <button
                                                type="button"
                                                onClick={checkAiStatus}
                                                className="w-full sm:w-auto inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-sky-400 hover:text-sky-600"
                                            >
                                                üîé V√©rifier l'IA
                                            </button>
                                        </div>
                                        <p className="text-[11px] text-slate-500 mt-1">Assure-toi que ce mod√®le est install√© via `ollama pull`.</p>
                                    </div>

                                </div>

                                {/* Actions */}
                                <div className="mt-6 space-y-3">
                                    <button
                                        onClick={startScan}
                                        disabled={status === 'scanning' || !config.path}
                                        className="w-full inline-flex items-center justify-center rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 disabled:cursor-not-allowed disabled:bg-slate-300"
                                    >
                                        üîç Scanner
                                    </button>

                                    <button
                                        onClick={startAnalyze}
                                        disabled={status === 'analyzing' || !candidates || candidates.length === 0}
                                        className="w-full inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-sky-400 hover:text-sky-600 disabled:cursor-not-allowed disabled:text-slate-400"
                                    >
                                        üß† Analyser avec IA
                                    </button>

                                    {(status === 'scanning' || status === 'analyzing') && (
                                        <button
                                            onClick={stopProcess}
                                            className="w-full inline-flex items-center justify-center rounded-full border border-rose-200 px-4 py-2 text-sm font-semibold text-rose-600 transition hover:border-rose-300"
                                        >
                                            ‚èπÔ∏è Stop
                                        </button>
                                    )}

                                    <button
                                        onClick={restartProcess}
                                        className="w-full inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300"
                                    >
                                        üîÑ Restart
                                    </button>
                                </div>
                            </div>

                            {/* Stats */}
                            {stats && (
                                <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                    <h2 className="text-2xl font-semibold text-slate-900 mb-4">üìä Statistiques</h2>
                                    <div className="space-y-3 text-sm text-slate-600">
                                        <div className="flex justify-between">
                                            <span>Total scann√©s</span>
                                            <span className="font-semibold text-slate-900">{stats.total_files || 0}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Candidats IA</span>
                                            <span className="font-semibold text-slate-900">{stats.candidate_count ?? candidates.length}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Analyser (limite)</span>
                                            <span className="font-semibold text-slate-900">{Math.min(candidates.length, config.max_files)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Prot√©g√©s d√©tect√©s</span>
                                            <span className="font-semibold text-rose-500">{protectedFiles.length}</span>
                                        </div>
                                        {stats.selected_categories && (
                                            <div className="text-xs text-slate-400">
                                                Filtres: {stats.selected_categories.join(', ')}
                                            </div>
                                        )}
                                        {stats.stats && Object.entries(stats.stats).map(([category, stat]) => (
                                            <div key={category} className="flex justify-between text-xs text-slate-500">
                                                <span>{category}</span>
                                                <span>{stat.count} fichiers ({stat.size_h})</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Colonne 2: R√©sultats & Actions */}
                        <div className="space-y-6">
                            {/* Candidats IA */}
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                <h2 className="text-2xl font-semibold text-slate-900 mb-4">üóÇÔ∏è Fichiers pr√™ts pour l'IA</h2>
                                {candidates && candidates.length > 0 ? (
                                    <div>
                                        <p className="text-xs text-slate-500 mb-4">{candidates.length} fichiers correspondent aux filtres s√©lectionn√©s.</p>
                                        <div className="space-y-3 max-h-64 overflow-y-auto pr-1">
                                            {candidates.slice(0, 8).map((file, idx) => (
                                                <div key={`${file.file}-${idx}`} className="rounded-2xl border border-slate-100 bg-slate-50/60 p-3">
                                                    <div className="flex justify-between text-sm text-slate-800">
                                                        <span className="font-semibold truncate pr-3">{file.name}</span>
                                                        <span className="text-slate-400">{file.category}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1">{file.size_h} ‚Ä¢ {file.age_days}j</div>
                                                </div>
                                            ))}
                                        </div>
                                        {candidates.length > 8 && (
                                            <p className="text-xs text-slate-500 mt-3 text-center">
                                                ... et {candidates.length - 8} autres fichiers
                                            </p>
                                        )}
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500">Lance un scan pour voir les fichiers analysables.</p>
                                )}
                            </div>

                            {/* Fichiers prot√©g√©s */}
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                <h2 className="text-2xl font-semibold text-slate-900 mb-4">üõ°Ô∏è Fichiers prot√©g√©s d√©tect√©s</h2>
                                {protectedFiles && protectedFiles.length > 0 ? (
                                    <div>
                                        <p className="text-xs text-slate-500 mb-4">{protectedFiles.length} fichiers contiennent des mots-cl√©s sensibles.</p>
                                        <div className="space-y-3 max-h-72 overflow-y-auto pr-1">
                                            {protectedFiles.map((file, idx) => (
                                                <div key={`${file.file || file.name}-protected-${idx}`} className="rounded-2xl border border-rose-100 bg-rose-50/70 p-3">
                                                    <div className="flex justify-between text-sm text-rose-700">
                                                        <span className="font-semibold truncate pr-3">{file.name}</span>
                                                        <span className="text-xs uppercase">{file.keyword}</span>
                                                    </div>
                                                    <div className="text-xs text-rose-600 mt-1">{file.size_h} ‚Ä¢ {file.age_days}j ‚Ä¢ {file.category}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500">Aucun document sensible d√©tect√© lors du dernier scan.</p>
                                )}
                            </div>

                            {/* Suppression rapide */}
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                <h2 className="text-2xl font-semibold text-slate-900 mb-4">‚ö° Suppression Rapide</h2>

                                {stats && stats.stats ? (
                                    <div>
                                        <p className="text-xs text-slate-500 mb-4">Coche les cat√©gories √† supprimer directement :</p>

                                        <div className="space-y-2">
                                            {Object.keys(quickDeleteCategories).map(category => {
                                                const categoryStats = stats.stats[category];
                                                if (!categoryStats || categoryStats.count === 0) return null;
                                                
                                                return (
                                                    <label key={category} className="flex items-center gap-3 rounded-2xl border border-slate-100 bg-slate-50/70 px-3 py-2 text-sm text-slate-700 cursor-pointer transition hover:border-slate-200">
                                                        <input
                                                            type="checkbox"
                                                            checked={quickDeleteCategories[category]}
                                                            onChange={(e) => setQuickDeleteCategories({
                                                                ...quickDeleteCategories,
                                                                [category]: e.target.checked
                                                            })}
                                                            className="w-4 h-4"
                                                        />
                                                        <span className="flex-1">
                                                            {category} ({categoryStats.count} - {categoryStats.size_h})
                                                        </span>
                                                    </label>
                                                );
                                            })}
                                        </div>

                                        <button
                                            onClick={quickDeleteByCategory}
                                            className="w-full mt-4 inline-flex items-center justify-center rounded-full bg-amber-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-amber-400"
                                        >
                                            üóëÔ∏è Supprimer les cat√©gories coch√©es
                                        </button>
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500">Lance un scan pour voir les cat√©gories</p>
                                )}
                            </div>

                            {/* Progress Scan */}
                            {status === 'scanning' && (
                                <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6 slide-in">
                                    <h2 className="text-2xl font-semibold text-slate-900 mb-4">üîç Scan en cours</h2>
                                    <div className="space-y-3 text-sm text-slate-600">
                                        <div className="flex justify-between">
                                            <span>{scanProgress.message}</span>
                                            <span>{scanProgress.scanned} fichiers</span>
                                        </div>
                                        <div className="w-full rounded-full bg-slate-200 h-3 overflow-hidden">
                                            <div className="bg-sky-500 h-full rounded-full thinking" style={{width: '100%'}}></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Progress Analyse */}
                            {status === 'analyzing' && (
                                <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6 slide-in">
                                    <h2 className="text-2xl font-semibold text-slate-900 mb-4">üß† Analyse IA</h2>
                                    <div className="space-y-4">
                                        <div className="space-y-2 text-sm text-slate-600">
                                            <div className="flex justify-between">
                                                <span>Progression</span>
                                                <span>{analyzeProgress.current} / {analyzeProgress.total}</span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                                                <div
                                                    className="bg-sky-500 h-full rounded-full transition-all duration-300"
                                                    style={{width: `${(analyzeProgress.current / analyzeProgress.total) * 100 || 0}%`}}
                                                ></div>
                                            </div>
                                        </div>

                                        <div className="text-xs text-slate-500 truncate">
                                            {analyzeProgress.file}
                                        </div>
                                        {aiThinking && (
                                            <div className="text-xs text-slate-600 bg-slate-100 border border-slate-200 p-3 rounded-2xl thinking">
                                                <div className="font-semibold mb-1">Analyse de {aiThinking.file}</div>
                                                {aiThinking.prompt && (
                                                    <div className="text-[11px] text-slate-500">Prompt: {truncate(aiThinking.prompt, 200)}</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* R√©sultats Analyse */}
                            {status === 'complete' && (
                                <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6 slide-in">
                                    <div className="grid grid-cols-3 gap-4 mb-6 text-center text-sm text-slate-600">
                                        <div className="rounded-2xl border border-emerald-100 bg-emerald-50/70 p-3">
                                            <div className="text-2xl font-semibold text-emerald-600">{results.can_delete.length}</div>
                                            <div>√Ä supprimer</div>
                                        </div>
                                        <div className="rounded-2xl border border-sky-100 bg-sky-50/70 p-3">
                                            <div className="text-2xl font-semibold text-sky-600">{results.should_keep.length}</div>
                                            <div>√Ä conserver</div>
                                        </div>
                                        <div className="rounded-2xl border border-amber-100 bg-amber-50/70 p-3">
                                            <div className="text-2xl font-semibold text-amber-600">{results.need_review.length}</div>
                                            <div>√Ä r√©viser</div>
                                        </div>
                                    </div>

                                    {results.can_delete.length > 0 && (
                                        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                                            <h3 className="text-lg font-semibold text-slate-900">üü¢ Suppression ({results.can_delete.length})</h3>
                                            <button
                                                onClick={deleteSelected}
                                                className="inline-flex items-center justify-center rounded-full bg-rose-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-500"
                                            >
                                                üóëÔ∏è Tout supprimer
                                            </button>
                                        </div>
                                    )}

                                    <div className="space-y-3 max-h-96 overflow-y-auto pr-1">
                                        {results.can_delete.slice(0, 10).map((r, i) => (
                                            <div key={i} className="rounded-2xl border border-emerald-100 bg-emerald-50/60 p-3">
                                                <div className="font-semibold text-emerald-700 text-sm truncate">{r.name}</div>
                                                <div className="text-xs text-emerald-600 mt-1">
                                                    {r.size_h} ‚Ä¢ {r.age_days}j ‚Ä¢ {r.category}
                                                </div>
                                                <div className="text-xs text-slate-500 mt-2">
                                                    üí° {r.reason}
                                                </div>
                                            </div>
                                        ))}
                                        {results.can_delete.length > 10 && (
                                            <div className="text-center text-xs text-slate-500">
                                                ... et {results.can_delete.length - 10} autres fichiers
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Colonne 3: Logs */}
                        <div className="space-y-6">
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-[0_25px_60px_rgba(15,23,42,0.05)] p-6">
                                <h2 className="text-2xl font-semibold text-slate-900 mb-4">üìú Logs</h2>
                                <div className="rounded-2xl border border-slate-100 bg-slate-950/90 text-slate-100 p-4 h-[600px] overflow-y-auto font-mono text-xs leading-relaxed">
                                    {logs.map((log, i) => (
                                        <div key={i} className="mb-3 slide-in">
                                            <div className={log.color || 'text-slate-100'}>
                                                <span className="text-slate-500">[{log.time}]</span> {log.message}
                                            </div>
                                            {log.detail && (
                                                <div className="text-[11px] text-slate-400 ml-10 mt-1">
                                                    üí° {log.detail}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>
</html>